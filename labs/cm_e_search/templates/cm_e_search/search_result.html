{% extends 'search/base.html' %}
{% block content %}

{% load static %}
<script src="{% static 'js/autocomplete.js' %}" type="text/javascript"></script>
<script>
    var availableTags = "{{data}}".replace(/&quot;/g, '"');
    var availableTags = JSON.parse(availableTags);
</script>
<script language="JavaScript" type="text/javascript" src="{% static 'js/jquery-1.12.4.min.js'%}"></script>
<script>
function more_items(classname) {

    var tail_items = document.getElementsByClassName(classname);
    var btn = document.getElementById("more_e");

    var i = 0;
    for (const item of tail_items) {
        if (item.style.display === "none") {
            item.style.display = "list-item";
            i++;
        }
        if (i > 9) {
            break;
        }
    }
    if (document.getElementById("less_e").style.display === "none") {
        document.getElementById("less_e").style.display = "block";
    }
}

function less_items(classname) {

    var tail_items = document.getElementsByClassName(classname);
    var btn = document.getElementById("less_e");

    var j = 0
    for (var i = tail_items.length-1; i >= 10; i--) {
        
        if (tail_items[i].style.display === "list-item") {
            tail_items[i].style.display = "none";
            j++;
        }
        if (j > 9) {
            break;
        }
        
    }     
}

function show_journal(counter) {
    
    var div = document.getElementById(counter);
    
    if (div.style.display === "none") {

        div.style.display = "block";
    } else  {
        div.style.display = "none";
    }
}
</script>

{% include "search/header.html" %}

<main>

<div class="col-12 col-sm-12 ml-xl-0 col-md-12 col-lg-9 col-xl-8">

<h1 class="text-center">Compact Memory Entity Search</h1>

    <form method="get" action="/cm_e_search/search_result/">
            <div class="col-xs-6">
                <input type="hidden" name="page" value="1">
                <div class="input-group">
                    <input class="form-control" id="entities" type="text" name="query" value="{{query}}">
                    <div class="input-group-btn">
                        <button type="submit" class="btn btn-light search_button"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>
        </form>

    <br><br>
    
    <div>
    {% if result|length < 1 %}
        <p>Could not find any matching entity in Compact Memory for this query. :(</p>

    {% else %}

        {% for r in result %}     
            <ul style="list-style-type: none;">
                    {% if r.e_type == 'PER' %}
                        <li><b>Name</b>: {{ r.name }} <span class="badge badge-warning">PER</span></li>
                    {% elif r.e_type == 'LOC' %}
                        <li><b>Name</b>: {{ r.name }} <span class="badge badge-info">LOC</span></li>
                    {% else %}
                        <li><b>Name</b>: {{ r.name }} <span class="badge badge-secondary">OTH</span></li>
                    {% endif %}

                    {% if r.ep != '' %}
                        <li><b>Entity Page</b>: <a href={{ r.ep }} target='_blank'>{{r.ep}}</a> </li>
                    {% endif %}
                    <li><b>Related entities</b>:<br>
                        <ul style="list-style-type: none;">
                            {% for related_entity in r.related_entities %} <!-- |slice:":10" -->
                                {% if forloop.counter <= 10 %}
                                <li style="display:list-item;" class="related_item">
                                {% else %}
                                <li style="display:none;" class="related_item">
                                {% endif %}
                                    {% if related_entity.3 == 'PER' %}
                                        <span class="badge badge-warning">PER</span>
                                    {% elif related_entity.3 == 'LOC' %}
                                        <span class="badge badge-info">LOC</span>
                                    {% else %}
                                        <span class="badge badge-secondary">OTH</span>
                                    {% endif %}
                                    <a href="{{related_entity.0}}">{{related_entity.1}}</a>
                                    ({{ related_entity.2|truncatechars:6}})
                                    <a href="/cm_e_search/search_result/?query={{related_entity.1}}"><img src="{% static '/img/lens.png' %}" alt='Query this entity'></a>
                                </li>
                            {% endfor %}
                            
                        </ul>
                        {% if r.related_entities|length > 10 %}
                            <br>
                            <button onclick="more_items('related_item')" class="btn btn-dark" type="button" id="more_e" style="display: inline-block; margin: 0 auto;">More entities</button>
                            <button onclick="less_items('related_item')" class="btn btn-outline-dark" type="button" id="less_e" style="display: inline-block; margin: 0 auto;">Less entities</button>
                        {% endif %}
                    </li>
                    <!-- END RELATED ENTITIES -->
                    
                    <hr style="border-top: 2px solid;">
                    
                    <!-- BEGIN JOURNAL MENTIONS -->
                    
                    <br>
                    <li><b>Occurs in Journals</b>:<br>
                        <p>(Number of mentions) | Journal | [Oldest mention - Latest mention]
                        <ul style="list-style-type: none;">
                            {% for journal_occ in r.journal_occs %} <!-- |slice:":10" -->
                                {% if  forloop.counter < 10 %}
                                    <li style="display:list-item;" class="journal">
                                {% else %}
                                    <li style="display:none;" class="journal">
                                {% endif %}
                                    ({{journal_occ.mentions|length}}) <a href="javascript:void(0);" onclick="show_journal('{{forloop.counter}}')">{{journal_occ.j_name}}</a> [{{journal_occ.first}} - {{journal_occ.last}}]
                                    <div class="mentions" id="{{forloop.counter}}" style="display: none; overflow-y: scroll; max-height: 400px;">

                                        <ul>
                                        {% for mention in journal_occ.mentions %}
                                            <ul style="list-style-type: none;">
                                                <li><i>Text</i>: {{mention.spot}}</li>
                                                <li><i>Date</i>: {{ mention.date }}</li>
                                                <li><i>Position (offset)</i>: {{mention.start}} - {{mention.end}}</li>
                                                <li><i>Ref. in Visual Library</i>: <a href="http://sammlungen.ub.uni-frankfurt.de/cm/periodical/pageview/{{ mention.p_link}}">Visual Library</a></li>
                                            </ul>
                                            <br>
                                        {% endfor %}
                                    </ul>
                                    </div>
                                </li>
                            {% endfor %}
                            
                        </ul>
                        {% if r.journal_occs|length > 10 %}
                            <br>
                            <button onclick="more_items('journal')" class="btn btn-dark" type="button" id="more_e" style="display: inline-block; margin: 0 auto;">More journals</button>
                            <button onclick="less_items('journal')" class="btn btn-outline-dark" type="button" id="less_e" style="display: inline-block; margin: 0 auto;">Less journals</button>
                        {% endif %}
                    </li>
                
                    <!-- END JOURNAL MENTIONS -->
                    <br>
            </ul>
        {% endfor %}
    {% endif %}
    </div>
    <br><br>
{% include "search/footer.html" %}
</div>
</main>
{% endblock content %}
